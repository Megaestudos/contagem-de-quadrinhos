<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Painel — Motoristas (Super App Mobile)</title>
<link id="manifestPlaceholder" rel="manifest">
<style>
  :root{
    --bg1: #0f172a;               /* dark base behind gradient */
    --glass: rgba(255,255,255,0.06);
    --card-bg: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    --accent-a: #7c3aed;          /* vibrant purple */
    --accent-b: #06b6d4;          /* cyan */
    --accent-c: #ff6b6b;          /* warm red */
    --text: #e6eef6;
    --muted: rgba(230,238,246,0.75);
    --radius-lg: 26px;
    --shadow-soft: 0 10px 30px rgba(2,6,23,0.6);
    font-family: Inter, Roboto, "Segoe UI", system-ui, -apple-system, sans-serif;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  html,body{height:100%;margin:0;background:
    radial-gradient(1200px 600px at 10% 10%, #071429 0%, transparent 10%),
    linear-gradient(180deg,#07192a 0%, #071129 100%); color:var(--text);}
  .app {
    max-width:760px;
    margin:0 auto;
    padding:22px 16px 80px;
  }

  header{
    display:flex;align-items:center;gap:12px;
    margin-bottom:10px;
  }
  .brand{
    width:54px;height:54px;border-radius:14px;
    background:linear-gradient(135deg,var(--accent-a),var(--accent-b));
    display:flex;align-items:center;justify-content:center;box-shadow:0 8px 30px rgba(12,16,26,0.6);
    flex-shrink:0;
  }
  .brand svg{filter:drop-shadow(0 6px 18px rgba(0,0,0,0.35));}
  h1{margin:0;font-size:20px;letter-spacing:0.2px}
  .subtitle{font-size:13px;color:var(--muted);margin-top:6px}

  /* quick stat row */
  .stats{display:flex;gap:12px;margin-top:14px}
  .stat{
    flex:1;background:var(--card-bg);border-radius:18px;padding:12px;
    box-shadow:var(--shadow-soft);border:1px solid rgba(255,255,255,0.03);
    min-width:0;transition:transform .18s ease;
  }
  .stat:hover{transform:translateY(-6px)}
  .stat .num{font-weight:700;font-size:18px;color:var(--text)}
  .stat .label{font-size:12px;color:var(--muted);margin-top:6px}

  /* rankings row */
  .rank-row{display:flex;gap:12px;margin-top:18px}
  .rank{flex:1;border-radius:20px;padding:14px;background:linear-gradient(135deg,var(--accent-a),var(--accent-b));color:white;
    box-shadow:0 14px 30px rgba(0,0,0,0.45);min-height:120px;position:relative;overflow:hidden}
  .rank.secondary{background:linear-gradient(135deg,#00c9a7,#01937c)}
  .rank h3{margin:0;font-size:14px;opacity:0.95}
  .leader-badge{position:absolute;top:14px;right:14px;background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:999px;font-weight:800}

  .rank-list{margin-top:12px;font-size:15px;line-height:1.4}
  .rank-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:12px;transition:transform .15s cubic-bezier(.2,.9,.3,1)}
  .rank-item:hover{transform:translateY(-6px)}
  .rank-pos{width:36px;height:36px;border-radius:10px;background:rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;font-weight:800}
  .rank-name{flex:1;min-width:0}
  .rank-count{font-weight:700;padding:6px 10px;border-radius:10px;background:rgba(255,255,255,0.06)}

  /* list cards (records) mobile-first: stacked cards */
  .list-section{margin-top:18px}
  .list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .list-card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));border-radius:20px;padding:14px;margin-bottom:10px;box-shadow:0 6px 18px rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.03);
    transition:transform .15s ease, box-shadow .15s ease;overflow:hidden}
  .list-card:active,.list-card:hover{transform:translateY(-6px);box-shadow:0 18px 36px rgba(0,0,0,0.5)}
  .card-top{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px}
  .card-driver{font-weight:800;font-size:16px}
  .card-mission{font-size:13px;color:var(--muted)}
  .chip{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.06);font-weight:700;font-size:13px}

  .small-muted{font-size:12px;color:var(--muted)}

  /* responsiveness */
  @media(min-width:900px){
    .rank-row{flex-direction:row}
    .stats{display:flex}
  }
  @media(max-width:520px){
    .brand{width:48px;height:48px}
    .stat .num{font-size:16px}
  }

</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand" aria-hidden="true">
        <!-- simple logo -->
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 12c0-4.9706 4.0294-9 9-9s9 4.0294 9 9c0 4.9706-4.0294 9-9 9s-9-4.0294-9-9z" fill="white" fill-opacity="0.12"/>
          <path d="M7 12h10M12 7v10" stroke="white" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div>
        <h1>Painel Motoristas</h1>
        <div class="subtitle small-muted">Chegadas cedo · Saídas após expediente</div>
      </div>
    </header>

    <div class="stats">
      <div class="stat" id="statTotal">
        <div class="num">—</div>
        <div class="label">Registros totais</div>
      </div>
      <div class="stat" id="statEarly">
        <div class="num">—</div>
        <div class="label">Chegadas cedo</div>
      </div>
      <div class="stat" id="statLate">
        <div class="num">—</div>
        <div class="label">Saídas tarde</div>
      </div>
    </div>

    <section class="rank-row">
      <div class="rank" role="region" aria-label="Ranking chegadas cedo">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <h3 style="margin:0">Chegadas cedo</h3>
            <div class="small-muted" style="margin-top:6px">Top 7 — Antes do expediente</div>
          </div>
          <div class="leader-badge" id="badgeAntes">TOP</div>
        </div>
        <div class="rank-list" id="rankListAntes" style="margin-top:12px">Carregando...</div>
      </div>

      <div class="rank secondary" role="region" aria-label="Ranking saídas tarde">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <h3 style="margin:0">Saídas tarde</h3>
            <div class="small-muted" style="margin-top:6px">Top 7 — Depois do expediente</div>
          </div>
          <div class="leader-badge" id="badgeDepois">TOP</div>
        </div>
        <div class="rank-list" id="rankListDepois" style="margin-top:12px">Carregando...</div>
      </div>
    </section>

    <!-- Antes section (cards list) -->
    <section class="list-section">
      <div class="list-header">
        <div>
          <div class="section-title" style="color:var(--text)">Registros — Antes do expediente</div>
          <div class="small-muted">Mais recentes primeiro</div>
        </div>
        <div class="small-muted">Aba: <strong>ANTES DO EXPEDIENTE</strong></div>
      </div>

      <div id="listAntes">
        <!-- cards inserted here -->
        <div class="small-muted">Carregando...</div>
      </div>
    </section>

    <!-- Depois section -->
    <section class="list-section">
      <div class="list-header">
        <div>
          <div class="section-title" style="color:var(--text)">Registros — Depois do expediente</div>
          <div class="small-muted">Mais recentes primeiro</div>
        </div>
        <div class="small-muted">Aba: <strong>DEPOIS DO EXPEDIENTE</strong></div>
      </div>

      <div id="listDepois">
        <div class="small-muted">Carregando...</div>
      </div>
    </section>
  </div>

<script>
/* ===================== CONFIGURAÇÃO ===================== */
const SHEET_ID = "1eaFPPSEpMxsdUY9m3vT_fOhoYUKYBzATv55nRHQwyTY";
const ABA_ANTES = "ANTES DO EXPEDIENTE";
const ABA_DEPOIS = "DEPOIS DO EXPEDIENTE";
const BASE_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=`;

/* ===================== HELPERS DE DATA ===================== */
/**
 * Converte valores retornados pelo Google GViz e também timestamps brutos.
 * Aceita:
 *  - "Date(2025,11,03)" ou "Date(1899,11,30,7,20,0)"
 *  - números (segundos ou milissegundos)
 *  - strings ISO
 */
function parseCellValue(v){
  if (v === null || v === undefined) return { date: null, text: "" };
  const s = String(v).trim();

  // Date(...) pattern
  const m = s.match(/^Date\(([-\d,\s]+)\)$/i);
  if (m){
    const parts = m[1].split(',').map(x=>parseInt(x.trim(),10));
    if (parts.length >= 3){
      const [year, monthZero, day, hour=0, minute=0, second=0] = parts;
      if (year < 1900){
        // time-only representation — use today's date with that time
        const now = new Date();
        const dt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, second);
        return { date: dt, text: "" };
      } else {
        const dt = new Date(year, monthZero, day, hour, minute, second);
        return { date: dt, text: "" };
      }
    }
  }

  // numeric timestamp?
  if (/^-?\d+$/.test(s)){
    const num = Number(s);
    // heuristic: if < 1e12 assume seconds -> convert to ms
    const ms = Math.abs(num) < 1e12 ? num * 1000 : num;
    const dt = new Date(ms);
    if (!isNaN(dt)) return { date: dt, text: "" };
  }

  // ISO or other date string
  const iso = Date.parse(s);
  if (!isNaN(iso)){
    return { date: new Date(iso), text: "" };
  }

  // fallback text
  return { date: null, text: s };
}

function formatDate(d){
  if (!d) return "";
  return d.toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric' });
}
function formatTime(d){
  if (!d) return "";
  return d.toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit' });
}

/* ===================== FETCH/ PARSING GVIZ ===================== */
async function fetchSheet(aba){
  const url = BASE_URL + encodeURIComponent(aba);
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error(`Falha HTTP ${res.status}`);
  const txt = await res.text();
  const start = txt.indexOf('{'), end = txt.lastIndexOf('}');
  if (start === -1 || end === -1) throw new Error('Resposta inesperada do Google Sheets');
  const obj = JSON.parse(txt.slice(start, end+1));
  const rows = (obj.table && obj.table.rows) ? obj.table.rows : [];
  // return array of arrays of cell values (prefer c.f when present)
  return rows.map(r => (r.c||[]).map(c => {
    if (!c) return null;
    if (c.f && typeof c.f === 'string') return c.f;
    if (c.v !== undefined && c.v !== null) return String(c.v);
    return null;
  }));
}

/* ===================== NORMALIZAÇÃO ===================== */
/* assume columns: motorista | data | horário | missão  (ignore extras) */
function normalizeRows(rawRows){
  return rawRows.map(r => {
    const motoristaRaw = r[0] || "";
    const dataRaw = r[1] || "";
    const horaRaw = r[2] || "";
    const missaoRaw = r[3] || "";

    const motorista = String(motoristaRaw).trim();

    const parsedDate = parseCellValue(dataRaw);
    const parsedTime = parseCellValue(horaRaw);

    // Compute combined dateObj for ordering (prefer explicit date+time)
    let dateObj = null;
    if (parsedDate.date && parsedTime.date){
      const d = parsedDate.date, t = parsedTime.date;
      dateObj = new Date(d.getFullYear(), d.getMonth(), d.getDate(), t.getHours(), t.getMinutes(), t.getSeconds());
    } else if (parsedDate.date && !parsedTime.date){
      dateObj = parsedDate.date;
    } else if (!parsedDate.date && parsedTime.date){
      const now = new Date();
      const t = parsedTime.date;
      dateObj = new Date(now.getFullYear(), now.getMonth(), now.getDate(), t.getHours(), t.getMinutes(), t.getSeconds());
    } else {
      const attempt = Date.parse(String(dataRaw) + ' ' + String(horaRaw));
      if (!isNaN(attempt)) dateObj = new Date(attempt);
    }

    const displayDate = parsedDate.date ? formatDate(parsedDate.date) : (parsedDate.text || '');
    const displayTime = parsedTime.date ? formatTime(parsedTime.date) : (parsedTime.text || '');

    return {
      motorista,
      dataText: displayDate,
      horaText: displayTime,
      missao: String(missaoRaw || ""),
      dateObj
    };
  });
}

/* ===================== RENDER HELPERS ===================== */
function clearEl(id){ const e = document.getElementById(id); if (e) e.innerHTML=''; }
function setText(id, text){ const e = document.getElementById(id); if (e) e.textContent = text; }

function renderRank(containerId, items){
  // count occurrences by motorista
  const counts = {};
  items.forEach(it => { const k = it.motorista || 'Sem nome'; counts[k] = (counts[k]||0) + 1; });
  const ranked = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,7);

  const container = document.getElementById(containerId);
  container.innerHTML = '';
  if (ranked.length === 0) { container.innerHTML = '<div class="small-muted">Sem registros</div>'; return; }

  ranked.forEach(([name, qty], idx) => {
    const wrapper = document.createElement('div');
    wrapper.className = 'rank-item';
    wrapper.style.display = 'flex';
    wrapper.style.alignItems = 'center';
    wrapper.style.justifyContent = 'space-between';

    const left = document.createElement('div');
    left.style.display = 'flex'; left.style.alignItems = 'center'; left.style.gap = '12px';

    const pos = document.createElement('div');
    pos.className = 'rank-pos';
    pos.textContent = (idx+1);
    pos.style.fontWeight = '800';
    pos.style.background = idx===0 ? 'rgba(255,255,255,0.22)' : 'rgba(255,255,255,0.08)';
    pos.style.color = '#fff';
    pos.style.width = '44px';
    pos.style.height = '44px';
    pos.style.display = 'flex';
    pos.style.alignItems = 'center';
    pos.style.justifyContent = 'center';
    pos.style.borderRadius = '10px';
    pos.style.fontSize = '15px';

    const nameEl = document.createElement('div');
    nameEl.className = 'rank-name';
    nameEl.innerHTML = `<div style="font-weight:800">${escapeHtml(name)}</div><div style="font-size:12px;opacity:.9"> ${qty} registro(s)</div>`;

    left.appendChild(pos);
    left.appendChild(nameEl);

    wrapper.appendChild(left);

    const right = document.createElement('div');
    right.className = 'rank-count';
    right.textContent = `${qty}`;
    right.style.background = 'rgba(255,255,255,0.08)';
    right.style.color = '#fff';
    right.style.padding = '8px 12px';
    right.style.borderRadius = '10px';
    right.style.fontWeight = '800';

    wrapper.appendChild(right);

    container.appendChild(wrapper);
  });
}

function renderList(containerId, items){
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  if (!items || items.length === 0) {
    container.innerHTML = '<div class="small-muted">Sem registros</div>';
    return;
  }

  items.forEach(it => {
    const card = document.createElement('div');
    card.className = 'list-card';
    // content
    card.innerHTML = `
      <div class="card-top">
        <div>
          <div class="card-driver">${escapeHtml(it.motorista)}</div>
          <div class="card-mission">${escapeHtml(it.missao)}</div>
        </div>
        <div style="text-align:right">
          <div class="chip">${escapeHtml(it.horaText || '')}</div>
          <div class="small-muted" style="margin-top:8px">${escapeHtml(it.dataText || '')}</div>
        </div>
      </div>
    `;
    container.appendChild(card);
  });
}

function updateStats(total, earlyCount, lateCount){
  setText('statTotal', String(total));
  setText('statEarly', String(earlyCount));
  setText('statLate', String(lateCount));
}

/* ===================== MAIN FLOW ===================== */
async function loadAll(){
  try {
    setText('status', 'Carregando dados...');
    const [rawAntes, rawDepois] = await Promise.all([fetchSheet(ABA_ANTES), fetchSheet(ABA_DEPOIS)]);
    const normAntes = normalizeRows(rawAntes).filter(r => r.motorista || r.dataText || r.horaText);
    const normDepois = normalizeRows(rawDepois).filter(r => r.motorista || r.dataText || r.horaText);

    // order most recent first
    const orderDesc = arr => arr.slice().sort((a,b) => {
      if (!a.dateObj && !b.dateObj) return 0;
      if (!a.dateObj) return 1;
      if (!b.dateObj) return -1;
      return b.dateObj - a.dateObj;
    });

    const orderedAntes = orderDesc(normAntes);
    const orderedDepois = orderDesc(normDepois);

    // limit show to 200 records each to keep UI snappy
    renderList('listAntes', orderedAntes.slice(0,200));
    renderList('listDepois', orderedDepois.slice(0,200));

    renderRank('rankListAntes', normAntes);
    renderRank('rankListDepois', normDepois);

    // simple counts: total rows & early/late counts - define early/late by presence in respective sheet
    updateStats(normAntes.length + normDepois.length, normAntes.length, normDepois.length);

    setText('status', 'Dados carregados com sucesso');
  } catch (err) {
    console.error(err);
    setText('status', 'Erro ao carregar dados: ' + (err.message || err));
    // show fallback
    document.getElementById('listAntes').innerHTML = '<div class="small-muted">Erro ao carregar a aba ANTES DO EXPEDIENTE</div>';
    document.getElementById('listDepois').innerHTML = '<div class="small-muted">Erro ao carregar a aba DEPOIS DO EXPEDIENTE</div>';
    document.getElementById('rankListAntes').innerHTML = '<div class="small-muted">—</div>';
    document.getElementById('rankListDepois').innerHTML = '<div class="small-muted">—</div>';
  }
}

/* ===================== UTIL ===================== */
function escapeHtml(s){
  if (s === null || s === undefined) return '';
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* ===================== INIT PWA (manifest + sw blob) ===================== */
(function initPWA(){
  try{
    const manifest = {
      name: "Painel Motoristas",
      short_name: "Motoristas",
      start_url: ".",
      display: "standalone",
      background_color: "#07192a",
      theme_color: "#1e90ff",
      icons: []
    };
    const mBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
    document.getElementById('manifestPlaceholder').href = URL.createObjectURL(mBlob);

    const swCode = `
      self.addEventListener('install', e => { self.skipWaiting(); });
      self.addEventListener('activate', e => { clients.claim(); });
      self.addEventListener('fetch', e => { e.respondWith(fetch(e.request)); });
    `;
    const swBlob = new Blob([swCode], {type:'text/javascript'});
    const swUrl = URL.createObjectURL(swBlob);
    if ('serviceWorker' in navigator) navigator.serviceWorker.register(swUrl).catch(()=>{/* ignore */});
  }catch(e){ console.warn('PWA init failed', e); }
})();

/* ===================== START ===================== */
loadAll();

</script>
</body>
</html>
