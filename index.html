<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Contagem de Motoristas — Painel</title>
<link id="manifestPlaceholder" rel="manifest"/>
<style>
  :root{
    --bg-1:#e8f7ff;
    --bg-2:#d8efff;
    --card-bg: rgba(255,255,255,0.72);
    --glass-border: rgba(255,255,255,0.5);
    --accent:#1e90ff;
    --muted:#234b60;
    --card-radius:16px;
    --shadow: 0 10px 30px rgba(11,36,64,0.10);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "Inter", "Segoe UI", Roboto, Arial, sans-serif;
    background: linear-gradient(180deg,var(--bg-1),var(--bg-2));
    -webkit-font-smoothing:antialiased;
    color:var(--muted);
  }
  header{
    padding:26px 16px;
    text-align:center;
  }
  h1{
    margin:0;
    font-size:26px;
    color:var(--accent);
    letter-spacing:0.2px;
  }
  .container{
    max-width:1100px;
    margin:18px auto 60px;
    padding:0 16px;
  }

  .panel{
    background:var(--card-bg);
    border-radius:var(--card-radius);
    padding:18px;
    margin:18px 0;
    box-shadow:var(--shadow);
    border:1px solid rgba(255,255,255,0.4);
    backdrop-filter: blur(6px) saturate(120%);
  }
  .row{display:flex;gap:18px;align-items:stretch}
  @media(max-width:880px){ .row{flex-direction:column} }

  .ranking-card{
    flex:1;
    border-radius:12px;
    padding:14px;
    color:#fff;
    position:relative;
    overflow:hidden;
    min-height:86px;
    display:flex;
    flex-direction:column;
    justify-content:center;
  }
  .rank-antes{ background: linear-gradient(135deg,#50a8ff,#2b9ed8); box-shadow: 0 8px 30px rgba(43,158,216,0.26); }
  .rank-depois{ background: linear-gradient(135deg,#00b894,#01936b); box-shadow: 0 8px 30px rgba(1,147,107,0.26); }

  .rank-title{ font-weight:700; font-size:15px; opacity:0.95; margin-bottom:8px; }
  .rank-list{ font-size:15px; line-height:1.5; }
  .leader{
    display:inline-block;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(255,255,255,0.14);
    font-weight:700;
    margin-right:10px;
  }

  .table-wrap{ overflow:auto; border-radius:12px; margin-top:12px; }
  table{
    width:100%;
    border-collapse:collapse;
    background:rgba(255,255,255,0.95);
    min-width:720px;
  }
  thead th{
    text-align:left;
    padding:12px;
    background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    border-bottom:2px solid rgba(14,74,110,0.06);
    color: #0d3b52;
    font-size:13px;
    position:sticky;
    top:0;
    z-index:2;
  }
  tbody td{
    padding:12px;
    border-bottom:1px solid rgba(14,74,110,0.04);
    font-size:14px;
    color: #0b3d51;
  }
  tbody tr:nth-child(odd){ background: linear-gradient(180deg, rgba(255,255,255,0.0), rgba(255,255,255,0.01)); }
  tbody tr:hover{ background: linear-gradient(90deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); }

  .muted{ color: rgba(11,36,64,0.5); font-size:13px; }
  .small{ font-size:13px; color: rgba(11,36,64,0.55) }
  .top1 { box-shadow: 0 6px 18px rgba(0,0,0,0.12); transform: translateY(-4px); }

  @media(max-width:720px){
    .ranking-card{min-height:72px;padding:12px}
    thead th, tbody td{padding:10px;font-size:13px}
  }
</style>
</head>
<body>
<header><h1>Contagem de Motoristas</h1></header>

<main class="container">
  <div id="status" class="panel muted">Carregando dados da planilha...</div>

  <section class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <div class="small" style="font-weight:700;color:var(--muted)">Top 7 — Chegadas Cedo</div>
        <div class="muted">Aba: <strong>ANTES DO EXPEDIENTE</strong></div>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div id="cardAntes" class="ranking-card rank-antes">
        <div class="rank-title">Chegadas cedo — Top 7</div>
        <div id="rankListAntes" class="rank-list">Carregando...</div>
      </div>

      <div id="cardDepois" class="ranking-card rank-depois">
        <div class="rank-title">Saídas tarde — Top 7</div>
        <div id="rankListDepois" class="rank-list">Carregando...</div>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="section-head" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
      <div>
        <div class="section-title" style="margin:0 0 6px 0">Registros — Antes do expediente</div>
        <div class="muted">Exibindo registros mais recentes primeiro</div>
      </div>
    </div>

    <div class="table-wrap" style="margin-top:12px">
      <table id="tableAntes">
        <thead>
          <tr><th>Motorista</th><th>Data</th><th>Horário</th><th>Missão</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="panel">
    <div class="section-head" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
      <div>
        <div class="section-title" style="margin:0 0 6px 0">Registros — Depois do expediente</div>
        <div class="muted">Exibindo registros mais recentes primeiro</div>
      </div>
    </div>

    <div class="table-wrap" style="margin-top:12px">
      <table id="tableDepois">
        <thead>
          <tr><th>Motorista</th><th>Data</th><th>Horário</th><th>Missão</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<script>
/* =================== CONFIG =================== */
const SHEET_ID = "1eaFPPSEpMxsdUY9m3vT_fOhoYUKYBzATv55nRHQwyTY";
const ABA_ANTES = "ANTES DO EXPEDIENTE";
const ABA_DEPOIS = "DEPOIS DO EXPEDIENTE";
const BASE_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=`;

/* =================== PARSE DE DATAS (CORRIGIDO) =================== */
function parseGoogleCell(value){
  if (value === null || value === undefined) return {date:null, text:""};

  const s = String(value).trim();

  const m = s.match(/^Date\(([-\d,\s]+)\)$/i);
  if (m){
    const p = m[1].split(',').map(n=>parseInt(n.trim(),10));
    if (p.length>=3){
      let [y,mn,d,h=0,mi=0,s2=0] = p;
      return {date:new Date(y,mn,d,h,mi,s2), text:""};
    }
  }

  const br = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (br){
    const dia = parseInt(br[1],10);
    const mes = parseInt(br[2],10)-1;
    const ano = parseInt(br[3],10);
    return {date:new Date(ano,mes,dia), text:""};
  }

  const iso = Date.parse(s);
  if (!isNaN(iso)){
    return {date:new Date(iso), text:""};
  }

  return {date:null, text:s};
}

function formatDate(d){
  if (!d) return "";
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}

function formatTime(d){
  if (!d) return "";
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}

/* =================== FETCH SHEET =================== */
async function fetchSheet(aba){
  const res = await fetch(BASE_URL + encodeURIComponent(aba), {cache:'no-store'});
  const txt = await res.text();
  const start = txt.indexOf('{');
  const end = txt.lastIndexOf('}');
  const json = JSON.parse(txt.slice(start,end+1));
  const rows = json.table.rows || [];
  return rows.map(r => (r.c||[]).map(c =>{
    if (!c) return null;
    if (c.f) return c.f;
    if (c.v!==undefined) return String(c.v);
    return null;
  }));
}

/* =================== NORMALIZE =================== */
function normalize(rows){
  return rows.map(r=>{
    const motorista = (r[0]||"").trim();
    const dataRaw = r[1]||"";
    const horaRaw = r[2]||"";
    const missao = r[3]||"";

    const d = parseGoogleCell(dataRaw);
    const h = parseGoogleCell(horaRaw);

    let dateObj=null;
    if (d.date && h.date){
      dateObj=new Date(d.date.getFullYear(),d.date.getMonth(),d.date.getDate(),h.date.getHours(),h.date.getMinutes());
    } else if (d.date){
      dateObj=d.date;
    }

    return{
      motorista,
      displayDate: d.date ? formatDate(d.date) : d.text,
      displayTime: h.date ? formatTime(h.date) : h.text,
      missao,
      dateObj
    };
  });
}

/* =================== ORDER =================== */
function orderByDateDesc(items){
  return items.slice().sort((a,b)=>{
    if (!a.dateObj && !b.dateObj) return 0;
    if (!a.dateObj) return 1;
    if (!b.dateObj) return -1;
    return b.dateObj - a.dateObj;
  });
}

/* =================== RENDER =================== */
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function renderTable(id,items){
  const tbody=document.querySelector(`#${id} tbody`);
  tbody.innerHTML="";
  items.forEach(it=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${escapeHtml(it.motorista)}</td>
      <td>${escapeHtml(it.displayDate)}</td>
      <td>${escapeHtml(it.displayTime)}</td>
      <td>${escapeHtml(it.missao)}</td>`;
    tbody.appendChild(tr);
  });
}

function renderRanking(id,items){
  const counts={};
  items.forEach(i=>{
    const k=i.motorista||"Sem nome";
    counts[k]=(counts[k]||0)+1;
  });
  const rank=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,7);
  const el=document.getElementById(id);
  el.innerHTML="";
  rank.forEach(([name,qty],i)=>{
    const div=document.createElement("div");
    if (i===0){
      div.className="top1";
      div.style.padding="8px";
      div.style.borderRadius="8px";
      div.style.background="rgba(255,255,255,0.06)";
      div.style.marginBottom="8px";
    } else div.style.marginBottom="6px";
    div.innerHTML=`${i+1}. <strong>${escapeHtml(name)}</strong> — ${qty} registro(s)`;
    el.appendChild(div);
  });
}

/* =================== MAIN =================== */
async function loadAll(){
  try{
    document.getElementById("status").textContent="Carregando dados...";
    const [a,b]=await Promise.all([
      fetchSheet(ABA_ANTES),
      fetchSheet(ABA_DEPOIS)
    ]);
    const na=orderByDateDesc(normalize(a));
    const nd=orderByDateDesc(normalize(b));
    renderTable("tableAntes",na);
    renderTable("tableDepois",nd);
    renderRanking("rankListAntes",na);
    renderRanking("rankListDepois",nd);
    document.getElementById("status").textContent="Dados carregados.";
  }catch(e){
    document.getElementById("status").textContent="Erro ao carregar: "+e.message;
    console.error(e);
  }
}

loadAll();
</script>
</body>
</html>
