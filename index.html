<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Contagem de Motoristas</title>

    <!-- Manifest dinâmico (criado via JS) -->
    <link id="manifestPlaceholder" rel="manifest" />

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(to bottom right, #87CEFA, #1E90FF);
            color: #000;
        }

        h1 {
            text-align: center;
            padding: 20px 0;
            font-size: 26px;
        }

        .container {
            width: 95%;
            margin: auto;
        }

        .section-title {
            font-size: 22px;
            margin-top: 25px;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            overflow: hidden;
        }

        th, td {
            padding: 10px;
            border-bottom: 1px solid #ccc;
            text-align: left;
            font-size: 15px;
        }

        th {
            background: #4682B4;
            color: white;
        }

        .ranking-box {
            padding: 15px;
            margin-top: 15px;
            border-radius: 12px;
            background: linear-gradient(to right, #6EC6FF, #2980FF);
            color: #fff;
            font-size: 18px;
        }
    </style>
</head>
<body>

<h1>Contagem de Motoristas</h1>
<div class="container">
    <div class="section-title">Antes do Expediente</div>
    <div class="ranking-box" id="rankingAntes">Carregando ranking...</div>
    <table id="tabelaAntes">
        <thead>
            <tr>
                <th>Motorista</th>
                <th>Data</th>
                <th>Horário</th>
                <th>Missão</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="section-title">Depois do Expediente</div>
    <div class="ranking-box" id="rankingDepois">Carregando ranking...</div>
    <table id="tabelaDepois">
        <thead>
            <tr>
                <th>Motorista</th>
                <th>Data</th>
                <th>Horário</th>
                <th>Missão</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
/*********************************************************
 CONFIGURAÇÕES
*********************************************************/
const SHEET_ID = "1eaFPPSEpMxsdUY9m3vT_fOhoYUKYBzATv55nRHQwyTY";
const API_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=`;

/*********************************************************
 FUNÇÃO PARA BUSCAR DADOS DE UMA ABA
*********************************************************/
async function carregarAba(aba) {
    try {
        const res = await fetch(API_URL + aba);
        const text = await res.text();
        const json = JSON.parse(text.substring(47, text.length - 2));

        const dados = json.table.rows.map(r => r.c.map(c => (c ? c.v : "")));
        return dados;
    } catch (e) {
        console.error("Erro ao carregar aba", aba, e);
        return [];
    }
}

/*********************************************************
 FUNÇÃO PARA ORDENAR POR DATA E HORÁRIO
*********************************************************/
function ordenar(dados) {
    return dados.sort((a, b) => {
        const dataA = new Date(a[1] + " " + a[2]);
        const dataB = new Date(b[1] + " " + b[2]);
        return dataA - dataB;
    });
}

/*********************************************************
 PREENCHER TABELA
*********************************************************/
function preencherTabela(idTabela, dados) {
    const tbody = document.querySelector(`#${idTabela} tbody`);
    tbody.innerHTML = "";

    dados.forEach(linha => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${linha[0]}</td>
            <td>${linha[1]}</td>
            <td>${linha[2]}</td>
            <td>${linha[3]}</td>
        `;
        tbody.appendChild(tr);
    });
}

/*********************************************************
 GERAR RANKING (TOP 7 MOTORISTAS)
*********************************************************/
function gerarRanking(idDiv, dados) {
    const contagem = {};

    dados.forEach(l => {
        const m = l[0];
        if (!contagem[m]) contagem[m] = 0;
        contagem[m]++;
    });

    const ranking = Object.entries(contagem)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 7)
        .map(e => `${e[0]} — ${e[1]} registros`)
        .join("<br>");

    document.getElementById(idDiv).innerHTML = ranking;
}

/*********************************************************
 CARREGAR TUDO
*********************************************************/
async function carregarTudo() {
    const antes = ordenar(await carregarAba("ANTES DO EXPEDIENTE"));
    const depois = ordenar(await carregarAba("DEPOIS DO EXPEDIENTE"));

    preencherTabela("tabelaAntes", antes);
    preencherTabela("tabelaDepois", depois);

    gerarRanking("rankingAntes", antes);
    gerarRanking("rankingDepois", depois);
}

carregarTudo();

/*********************************************************
 MANIFEST + SERVICE WORKER DINÂMICOS (PWA)
*********************************************************/
// Criar MANIFEST dinamicamente
const manifest = {
    name: "Contagem de Motoristas",
    short_name: "Motoristas",
    start_url: ".",
    display: "standalone",
    background_color: "#87CEFA",
    theme_color: "#1E90FF",
    icons: []
};

const blobManifest = new Blob([JSON.stringify(manifest)], { type: "application/json" });
const manifestURL = URL.createObjectURL(blobManifest);
document.getElementById("manifestPlaceholder").setAttribute("href", manifestURL);

// Criar SERVICE WORKER dinâmico
tif = `self.addEventListener('install', e => { self.skipWaiting(); });
self.addEventListener('activate', e => { clients.claim(); });
self.addEventListener('fetch', e => { e.respondWith(fetch(e.request)); });`;

const swBlob = new Blob([tif], { type: "text/javascript" });
const swURL = URL.createObjectURL(swBlob);

if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register(swURL);
}
</script>

</body>
</html>
