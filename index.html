<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Controle de Motoristas</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #eef2f7;
        margin: 0;
        padding: 0;
    }
    h1 {
        text-align: center;
        margin-top: 20px;
        color: #333;
    }
    .section {
        background: #fff;
        width: 92%;
        margin: 20px auto;
        padding: 20px;
        border-radius: 18px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.15);
    }
    h2 {
        color: #222;
        margin-bottom: 10px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
    }
    thead {
        background: #1976d2;
        color: #fff;
    }
    th, td {
        padding: 10px;
        font-size: 15px;
        border-bottom: 1px solid #ddd;
        text-align: left;
    }
    tr:nth-child(even) { background: #f4f7fb; }
    .loading { text-align: center; padding: 10px; font-size: 16px; }
    .rank-card {
        padding: 12px;
        border-radius: 14px;
        margin: 8px 0;
        background: linear-gradient(135deg, #4facfe, #00f2fe);
        color: #fff;
        font-weight: bold;
        font-size: 18px;
    }
</style>
</head>

<body>

<h1>Controle de Motoristas</h1>

<div class="section">
    <h2>Top 7 — Chegadas cedo</h2>
    <div id="rankingBefore"></div>
</div>

<div class="section">
    <h2>Top 7 — Saídas tarde</h2>
    <div id="rankingAfter"></div>
</div>

<div class="section">
    <h2>Antes do expediente</h2>
    <div id="loadBefore" class="loading">Carregando...</div>
    <table>
        <thead>
            <tr>
                <th>Motorista</th>
                <th>Data</th>
                <th>Horário</th>
                <th>Missão</th>
            </tr>
        </thead>
        <tbody id="tableBefore"></tbody>
    </table>
</div>

<div class="section">
    <h2>Depois do expediente</h2>
    <div id="loadAfter" class="loading">Carregando...</div>
    <table>
        <thead>
            <tr>
                <th>Motorista</th>
                <th>Data</th>
                <th>Horário</th>
                <th>Missão</th>
            </tr>
        </thead>
        <tbody id="tableAfter"></tbody>
    </table>
</div>

<script>
const sheetId = "1eaFPPSEpMxsdUY9m3vT_fOhoYUKYBzATv55nRHQwyTY";

const urlBefore = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=ANTES%20DO%20EXPEDIENTE`;
const urlAfter  = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=DEPOIS%20DO%20EXPEDIENTE`;

/* ------------------------------  CORREÇÃO ABSOLUTA DE DATA  ------------------------------ */
function fixDate(value) {
    if (!value) return "";

    // Caso seja number (serial date)
    if (typeof value === "number") {
        const base = new Date(1899, 11, 30);
        const corrected = new Date(base.getTime() + value * 86400000);
        return formatDate(corrected);
    }

    // Caso seja date object vindo do Google
    if (typeof value === "object" && value.v !== undefined && value.f === undefined) {
        const corrected = new Date(value.v);
        return formatDate(corrected);
    }

    // Caso seja texto dd/mm/yyyy → retorna direto
    if (typeof value === "string" && value.includes("/")) return value;

    return value;
}

function formatDate(d) {
    const dia = String(d.getDate()).padStart(2, "0");
    const mes = String(d.getMonth() + 1).padStart(2, "0");
    const ano = d.getFullYear();
    return `${dia}/${mes}/${ano}`;
}
/* ----------------------------------------------------------------------------------------- */


async function loadSheet(url) {
    try {
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));

        return json.table.rows.map(r => r.c.map(c => c ? c.v : ""));
    } catch (e) {
        console.error("Erro ao ler:", url, e);
        return [];
    }
}

function renderTable(data, elementId) {
    const tbody = document.getElementById(elementId);
    tbody.innerHTML = "";

    data.forEach(r => {
        tbody.innerHTML += `
            <tr>
                <td>${r.motorista}</td>
                <td>${r.data}</td>
                <td>${r.horario}</td>
                <td>${r.missao}</td>
            </tr>
        `;
    });
}

function generateRanking(data, containerId) {
    const counts = {};

    data.forEach(r => {
        if (!counts[r.motorista]) counts[r.motorista] = 0;
        counts[r.motorista]++;
    });

    const sorted = Object.entries(counts)
        .sort((a,b) => b[1] - a[1])
        .slice(0,7);

    const container = document.getElementById(containerId);
    container.innerHTML = "";

    sorted.forEach(([name, total]) => {
        container.innerHTML += `
            <div class="rank-card">
                ${name} — ${total}
            </div>
        `;
    });
}

async function loadApp() {
    const beforeRaw = await loadSheet(urlBefore);
    const afterRaw  = await loadSheet(urlAfter);

    document.getElementById("loadBefore").style.display = "none";
    document.getElementById("loadAfter").style.display = "none";

    const before = beforeRaw.map(r => ({
        motorista: r[0],
        data: fixDate(r[1]),
        horario: r[2],
        missao: r[3]
    }));

    const after = afterRaw.map(r => ({
        motorista: r[0],
        data: fixDate(r[1]),
        horario: r[2],
        missao: r[3]
    }));

    renderTable(before, "tableBefore");
    renderTable(after, "tableAfter");

    generateRanking(before, "rankingBefore");
    generateRanking(after, "rankingAfter");
}

loadApp();
</script>

</body>
</html>
