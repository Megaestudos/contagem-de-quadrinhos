<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Contagem de Motoristas</title>

    <link id="manifestPlaceholder" rel="manifest" />

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(to bottom right, #8ED6FF, #4A90E2);
        }

        h1 {
            text-align: center;
            padding: 20px 0;
            font-size: 28px;
        }

        .container { width: 95%; margin: auto; }

        .section-title {
            font-size: 22px;
            margin-top: 25px;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        th, td { padding: 10px; border-bottom: 1px solid #ddd; }
        th { background: #2C3E50; color: white; }

        .ranking-box {
            padding: 15px;
            margin-top: 15px;
            border-radius: 12px;
            background: linear-gradient(to right, #005BEA, #00C6FB);
            color: white;
            font-size: 18px;
        }

        .ranking-box.secondary {
            background: linear-gradient(to right, #FF512F, #DD2476);
        }
    </style>
</head>
<body>

<h1>Contagem de Motoristas</h1>
<div class="container">
    <div class="section-title">Antes do Expediente</div>
    <div class="ranking-box" id="rankingAntes">Carregando ranking...</div>
    <table id="tabelaAntes">
        <thead>
            <tr><th>Motorista</th><th>Data</th><th>Horário</th><th>Missão</th></tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="section-title">Depois do Expediente</div>
    <div class="ranking-box secondary" id="rankingDepois">Carregando ranking...</div>
    <table id="tabelaDepois">
        <thead>
            <tr><th>Motorista</th><th>Data</th><th>Horário</th><th>Missão</th></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
const SHEET_ID = "1eaFPPSEpMxsdUY9m3vT_fOhoYUKYBzATv55nRHQwyTY";
const API_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=`;

function formatarData(valor) {
    if (typeof valor === "string") return valor;
    if (!valor) return "";
    const d = new Date(valor);
    return d.toLocaleDateString("pt-BR");
}

function formatarHora(valor) {
    if (typeof valor === "string") return valor;
    if (!valor) return "";
    const d = new Date(valor);
    return d.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
}

async function carregarAba(aba) {
    try {
        const res = await fetch(API_URL + encodeURIComponent(aba));
        const text = await res.text();
        const json = JSON.parse(text.substring(47, text.length - 2));

        return json.table.rows.map(r => r.c.map(c => (c ? c.v : "")));
    } catch (e) {
        console.error("Erro ao carregar aba", aba, e);
        return [];
    }
}

function ordenar(dados) {
    return dados.sort((a, b) => {
        const dA = new Date(a[1] + " " + a[2]);
        const dB = new Date(b[1] + " " + b[2]);
        return dA - dB;
    });
}

function preencherTabela(idTabela, dados) {
    const tbody = document.querySelector(`#${idTabela} tbody`);
    tbody.innerHTML = "";

    dados.forEach(linha => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${linha[0]}</td>
            <td>${formatarData(linha[1])}</td>
            <td>${formatarHora(linha[2])}</td>
            <td>${linha[3]}</td>`;
        tbody.appendChild(tr);
    });
}

function gerarRanking(idDiv, dados) {
    const cont = {};

    dados.forEach(l => { cont[l[0]] = (cont[l[0]] || 0) + 1 });

    const ranking = Object.entries(cont)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 7)
        .map(e => `${e[0]} — ${e[1]} registros`)
        .join("<br>");

    document.getElementById(idDiv).innerHTML = ranking;
}

async function carregarTudo() {
    const antes = ordenar(await carregarAba("ANTES DO EXPEDIENTE"));
    const depois = ordenar(await carregarAba("DEPOIS DO EXPEDIENTE"));

    preencherTabela("tabelaAntes", antes);
    preencherTabela("tabelaDepois", depois);

    gerarRanking("rankingAntes", antes);
    gerarRanking("rankingDepois", depois);
}

carregarTudo();

// Manifest + service worker simples
const manifest = { name: "Contagem Motoristas", short_name: "Motoristas", start_url: ".", display: "standalone", background_color: "#8ED6FF", theme_color: "#4A90E2" };
const blob = new Blob([JSON.stringify(manifest)], { type: "application/json" });
document.getElementById("manifestPlaceholder").href = URL.createObjectURL(blob);

const sw = new Blob([
`self.addEventListener('install',()=>self.skipWaiting());
 self.addEventListener('activate',()=>clients.claim());
 self.addEventListener('fetch',e=>e.respondWith(fetch(e.request)));`
], { type: "text/javascript" });

if ("serviceWorker" in navigator) navigator.serviceWorker.register(URL.createObjectURL(sw));
</script>

</body>
</html>
