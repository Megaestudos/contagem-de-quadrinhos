<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard — Motoristas (Material)</title>
<style>
  :root{
    --bg:#f4f6fb;
    --surface:#ffffff;
    --primary:#0b63d4;
    --secondary:#06b6d4;
    --danger:#e94545;
    --text:#0f1724;
    --muted:#546e7a;
    --card-radius:12px;
    --elevation-1: 0 1px 3px rgba(16,24,40,0.08);
    --elevation-2: 0 6px 18px rgba(16,24,40,0.12);
    font-family: "Roboto", "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#eef6ff);color:var(--text)}
  .wrap{max-width:1200px;margin:20px auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:54px;height:54px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;box-shadow:var(--elevation-2);}
  h1{font-size:20px;margin:0}
  .subtitle{color:var(--muted);font-size:13px}
  .controls{display:flex;gap:12px;align-items:center}
  .btn{background:var(--primary);color:white;padding:10px 14px;border-radius:10px;border:none;font-weight:600;cursor:pointer;box-shadow:var(--elevation-1);}
  .chip{background:var(--surface);border-radius:999px;padding:8px 12px;border:1px solid rgba(16,24,40,0.04);font-weight:600;color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:18px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--surface);border-radius:var(--card-radius);padding:16px;box-shadow:var(--elevation-1)}
  .stats{display:flex;gap:12px;flex-wrap:wrap}
  .stat-card{flex:1;min-width:140px;background:linear-gradient(180deg,#ffffff,#f7fbff);padding:12px;border-radius:10px;border:1px solid rgba(16,24,40,0.03)}
  .stat-num{font-size:20px;font-weight:800;color:var(--primary)}
  .stat-label{font-size:13px;color:var(--muted);margin-top:6px}
  .ranking{display:flex;flex-direction:column;gap:10px}
  .rank-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;background:rgba(0,0,0,0.03)}
  .avatar{width:40px;height:40px;border-radius:8px;background:rgba(0,0,0,0.05);display:flex;align-items:center;justify-content:center;font-weight:700}
  .bar{height:8px;border-radius:999px;background:rgba(0,0,0,0.06);overflow:hidden;margin-left:8px;min-width:120px}
  .bar-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));border-radius:999px}
  .table-wrap{margin-top:12px;border-radius:10px;overflow:hidden;border:1px solid rgba(16,24,40,0.04)}
  table{width:100%;border-collapse:collapse;background:var(--surface);min-width:720px}
  thead th{position:sticky;top:0;background:#f6fbff;padding:12px;text-align:left;font-weight:700;border-bottom:1px solid rgba(16,24,40,0.06)}
  tbody td{padding:12px;border-bottom:1px solid rgba(16,24,40,0.03);font-size:14px;color:var(--text)}
  tbody tr:nth-child(odd){background:#ffffff}
  tbody tr:nth-child(even){background:#fbfdff}
  .muted{color:var(--muted);font-size:13px}
  .right-panel{display:flex;flex-direction:column;gap:12px}
  .mini-card{padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#f7fbff);border:1px solid rgba(16,24,40,0.03)}
  .badge{display:inline-block;padding:6px 10px;border-radius:8px;background:var(--primary);color:white;font-weight:700;font-size:13px}
  @media(max-width:720px){.grid{grid-template-columns:1fr}.right-panel{order:2}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">MG</div>
      <div>
        <h1>Dashboard Motoristas</h1>
        <div class="subtitle">Chegadas cedo · Saídas após expediente</div>
      </div>
    </div>
    <div class="controls">
      <div class="chip">Planilha: pública</div>
      <button class="btn" id="refreshBtn">Atualizar</button>
    </div>
  </header>

  <main class="grid">
    <section>
      <div class="card">
        <div class="stats">
          <div class="stat-card">
            <div class="stat-num" id="statTotal">—</div>
            <div class="stat-label">Registros (total)</div>
          </div>
          <div class="stat-card">
            <div class="stat-num" id="statEarly">—</div>
            <div class="stat-label">Chegadas cedo</div>
          </div>
          <div class="stat-card">
            <div class="stat-num" id="statLate">—</div>
            <div class="stat-label">Saídas tarde</div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Top 7 — Chegadas cedo</div>
          <div class="muted">ANTES DO EXPEDIENTE</div>
        </div>
        <div class="ranking" id="rankingEarly" style="margin-top:10px"></div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Top 7 — Saídas tarde</div>
          <div class="muted">DEPOIS DO EXPEDIENTE</div>
        </div>
        <div class="ranking" id="rankingLate" style="margin-top:10px"></div>
      </div>

      <div class="card" style="margin-top:14px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Registros — Antes do expediente</div>
          <div class="muted">Mais recentes primeiro</div>
        </div>
        <div class="table-wrap" style="margin-top:10px">
          <table id="tableEarly">
            <thead>
              <tr><th>Motorista</th><th>Data</th><th>Horário</th><th>Missão</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Registros — Depois do expediente</div>
          <div class="muted">Mais recentes primeiro</div>
        </div>
        <div class="table-wrap" style="margin-top:10px">
          <table id="tableLate">
            <thead>
              <tr><th>Motorista</th><th>Data</th><th>Horário</th><th>Missão</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <aside class="right-panel">
      <div class="mini-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Resumo Rápido</div>
          <div class="badge" id="badgeStatus">OK</div>
        </div>
        <div class="mini-list" id="miniList" style="margin-top:8px">
          <div class="muted">Carregando resumo...</div>
        </div>
      </div>

      <div class="mini-card">
        <div style="font-weight:800">Últimas 5 ocorrências</div>
        <div id="lastFive" style="margin-top:10px" class="muted">Carregando...</div>
      </div>

      <div class="mini-card">
        <div style="font-weight:800">Ajuda</div>
        <div class="muted" style="margin-top:8px">Planilha pública (Arquivo → Publicar na web). Colunas: motorista | data | horário | missão</div>
      </div>
    </aside>
  </main>
</div>

<script>
/* ---------------- CONFIGURAÇÃO ---------------- */
const SHEET_ID = "1eaFPPSEpMxsdUY9m3vT_fOhoYUKYBzATv55nRHQwyTY";
const SHEET_EARLY = "ANTES DO EXPEDIENTE";
const SHEET_LATE = "DEPOIS DO EXPEDIENTE";
const BASE = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=`;

/* ---------------- util: robust date parser ---------------- */
function parseCell(v){
  if (v == null) return {date:null,text:""};
  const s = String(v).trim();

  // 1) Google Date(...) pattern
  const m = s.match(/^Date\(([-\d,\s]+)\)$/i);
  if (m){
    const parts = m[1].split(',').map(x=>parseInt(x.trim(),10));
    if (parts.length >= 3){
      const [yr, mon0, day, hr=0, min=0, sec=0] = parts;
      if (!isNaN(yr) && !isNaN(mon0) && !isNaN(day)){
        // when year < 1900 Google sometimes encodes time-only -> treat as time-of-day
        if (yr < 1900){
          const now = new Date();
          return { date: new Date(now.getFullYear(), now.getMonth(), now.getDate(), hr, min, sec), text: "" };
        }
        return { date: new Date(yr, mon0, day, hr, min, sec), text: "" };
      }
    }
  }

  // 2) numeric timestamp (seconds or ms)
  if (/^-?\d+$/.test(s)){
    const num = Number(s);
    const ms = Math.abs(num) < 1e12 ? num * 1000 : num;
    const d = new Date(ms);
    if (!isNaN(d)) return {date:d,text:""};
  }

  // 3) ISO date string (YYYY-MM-DD or variants) - safe parse
  const iso = Date.parse(s);
  if (!isNaN(iso)) return { date: new Date(iso), text: "" };

  // 4) dd/mm/yyyy or dd-mm-yyyy (pt-BR) -> parse as day/month/year
  const dm = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (dm){
    let day = parseInt(dm[1],10), month = parseInt(dm[2],10), year = parseInt(dm[3],10);
    if (year < 100) year += 2000;
    // JS months are 0-based
    const d = new Date(year, month - 1, day);
    if (!isNaN(d)) return {date:d, text:""};
  }

  // fallback -> text
  return {date:null, text:s};
}

/* ---------------- fetch and parse sheet (GViz) ---------------- */
async function fetchSheet(name){
  const url = BASE + encodeURIComponent(name);
  const res = await fetch(url, {cache:'no-store'});
  if (!res.ok) throw new Error('HTTP ' + res.status);
  const txt = await res.text();
  const start = txt.indexOf('{'), end = txt.lastIndexOf('}');
  if (start === -1 || end === -1) throw new Error('Resposta inesperada do Google Sheets');
  const obj = JSON.parse(txt.slice(start, end+1));
  const rows = (obj.table && obj.table.rows) ? obj.table.rows : [];
  return rows.map(r => (r.c || []).map(c => {
    if (!c) return null;
    if (c.f && typeof c.f === 'string') return c.f;
    if (c.v !== undefined && c.v !== null) return String(c.v);
    return null;
  }));
}

/* ---------------- normalize rows ---------------- */
function normalize(rows){
  return rows.map(r => {
    const motoristaRaw = r[0] || "";
    const dataRaw = r[1] || "";
    const horaRaw = r[2] || "";
    const missaoRaw = r[3] || "";

    const motorista = String(motoristaRaw).trim();
    const pd = parseCell(dataRaw);
    const pt = parseCell(horaRaw);

    let dateObj = null;
    if (pd.date && pt.date){
      const d = pd.date, t = pt.date;
      dateObj = new Date(d.getFullYear(), d.getMonth(), d.getDate(), t.getHours(), t.getMinutes(), t.getSeconds());
    } else if (pd.date){
      dateObj = pd.date;
    } else if (pt.date){
      const now = new Date();
      const t = pt.date;
      dateObj = new Date(now.getFullYear(), now.getMonth(), now.getDate(), t.getHours(), t.getMinutes(), t.getSeconds());
    } else {
      const attempt = Date.parse(String(dataRaw) + ' ' + String(horaRaw));
      if (!isNaN(attempt)) dateObj = new Date(attempt);
    }

    const displayDate = pd.date ? pd.date.toLocaleDateString('pt-BR') : (pd.text || "");
    const displayTime = pt.date ? pt.date.toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'}) : (pt.text || "");

    return {motorista, displayDate, displayTime, missao: String(missaoRaw||""), dateObj};
  });
}

/* ---------------- render helpers ---------------- */
function escapeHtml(s){ if (s==null) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function renderTable(tableId, items){
  const tbody = document.querySelector(`#${tableId} tbody`);
  tbody.innerHTML = '';
  items.forEach(it => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(it.motorista)}</td><td>${escapeHtml(it.displayDate)}</td><td>${escapeHtml(it.displayTime)}</td><td>${escapeHtml(it.missao)}</td>`;
    tbody.appendChild(tr);
  });
}
function renderRanking(containerId, items){
  const counts = {};
  items.forEach(i => { const k = i.motorista || 'Sem nome'; counts[k] = (counts[k]||0)+1; });
  const ranked = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,7);
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  if (ranked.length===0){ container.innerHTML = '<div class="muted">Sem registros</div>'; return; }
  const max = ranked[0][1] || 1;
  ranked.forEach(([name,qty],idx)=>{
    const card = document.createElement('div');
    card.className = 'rank-item';
    const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='12px';
    const avatar = document.createElement('div'); avatar.className='avatar'; avatar.textContent = name.split(' ').map(w=>w[0]||'').slice(0,2).join('').toUpperCase();
    const ndiv = document.createElement('div'); ndiv.innerHTML = `<div style="font-weight:700">${escapeHtml(name)}</div><div style="font-size:12px;color:var(--muted)">${qty} ocorrência(s)</div>`;
    const barWrap = document.createElement('div'); barWrap.className='bar';
    const fill = document.createElement('div'); fill.className='bar-fill'; fill.style.width = Math.round((qty/max)*100) + '%';
    barWrap.appendChild(fill);
    left.appendChild(avatar); left.appendChild(ndiv); left.appendChild(barWrap);
    const right = document.createElement('div'); right.style.fontWeight='800'; right.style.minWidth='48px'; right.style.textAlign='right'; right.textContent = qty;
    card.appendChild(left); card.appendChild(right);
    container.appendChild(card);
  });
}
function updateSummary(total, earlyCount, lateCount, lastFive){
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statEarly').textContent = earlyCount;
  document.getElementById('statLate').textContent = lateCount;
  document.getElementById('miniList').innerHTML = `<div>Chegadas cedo: ${earlyCount}</div><div>Saídas tarde: ${lateCount}</div>`;
  document.getElementById('lastFive').innerHTML = lastFive.map(it=>`${escapeHtml(it.motorista)} — ${escapeHtml(it.displayDate)} ${escapeHtml(it.displayTime)}<br>`).join('');
  document.getElementById('badgeStatus').textContent = 'OK';
}

/* ---------------- main flow ---------------- */
async function loadAll(){
  try {
    document.getElementById('badgeStatus').textContent = 'Carregando...';
    const [rawEarly, rawLate] = await Promise.all([fetchSheet(SHEET_EARLY), fetchSheet(SHEET_LATE)]);
    const normEarly = normalize(rawEarly).filter(r => r.motorista || r.displayDate || r.displayTime);
    const normLate = normalize(rawLate).filter(r => r.motorista || r.displayDate || r.displayTime);
    const orderDesc = arr => arr.slice().sort((a,b)=>{
      if (!a.dateObj && !b.dateObj) return 0;
      if (!a.dateObj) return 1;
      if (!b.dateObj) return -1;
      return b.dateObj - a.dateObj;
    });
    const orderedEarly = orderDesc(normEarly);
    const orderedLate = orderDesc(normLate);
    renderTable('tableEarly', orderedEarly);
    renderTable('tableLate', orderedLate);
    renderRanking('rankingEarly', normEarly);
    renderRanking('rankingLate', normLate);
    const lastFive = orderedEarly.slice(0,3).concat(orderedLate.slice(0,2));
    updateSummary(normEarly.length + normLate.length, normEarly.length, normLate.length, lastFive);
    document.getElementById('badgeStatus').textContent = 'Concluído';
  } catch (err){
    console.error(err);
    document.getElementById('badgeStatus').textContent = 'Erro';
    document.getElementById('miniList').innerHTML = `<div class="muted">Erro: ${escapeHtml(err.message || String(err))}</div>`;
  }
}

/* ---------------- fetch helper GViz ---------------- */
async function fetchSheet(name){
  const url = BASE + encodeURIComponent(name);
  const res = await fetch(url, {cache:'no-store'});
  if (!res.ok) throw new Error('HTTP ' + res.status);
  const txt = await res.text();
  const start = txt.indexOf('{'), end = txt.lastIndexOf('}');
  if (start===-1 || end===-1) throw new Error('Formato inesperado');
  const obj = JSON.parse(txt.slice(start,end+1));
  const rows = (obj.table && obj.table.rows) ? obj.table.rows : [];
  return rows.map(r => (r.c||[]).map(c=>{
    if (!c) return null;
    if (c.f && typeof c.f === 'string') return c.f;
    if (c.v !== undefined && c.v !== null) return String(c.v);
    return null;
  }));
}

document.getElementById('refreshBtn').addEventListener('click', ()=>loadAll());
loadAll();
</script>
</body>
</html>
