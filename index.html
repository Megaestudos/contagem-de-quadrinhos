<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Contagem de Motoristas — Painel</title>
<link id="manifestPlaceholder" rel="manifest"/>
<style>
  /* ===== Base & Background (glass / neomorphism) ===== */
  :root{
    --bg-1:#e8f7ff;
    --bg-2:#d8efff;
    --card-bg: rgba(255,255,255,0.72);
    --glass-border: rgba(255,255,255,0.5);
    --accent:#1e90ff;
    --muted:#234b60;
    --card-radius:16px;
    --shadow: 0 10px 30px rgba(11,36,64,0.10);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "Inter", "Segoe UI", Roboto, Arial, sans-serif;
    background: linear-gradient(180deg,var(--bg-1),var(--bg-2));
    -webkit-font-smoothing:antialiased;
    color:var(--muted);
  }
  header{
    padding:26px 16px;
    text-align:center;
  }
  h1{
    margin:0;
    font-size:26px;
    color:var(--accent);
    letter-spacing:0.2px;
  }
  .container{
    max-width:1100px;
    margin:18px auto 60px;
    padding:0 16px;
  }

  /* ===== Cards ===== */
  .panel{
    background:var(--card-bg);
    border-radius:var(--card-radius);
    padding:18px;
    margin:18px 0;
    box-shadow:var(--shadow);
    border:1px solid rgba(255,255,255,0.4);
    backdrop-filter: blur(6px) saturate(120%);
  }
  .row{display:flex;gap:18px;align-items:stretch}
  @media(max-width:880px){ .row{flex-direction:column} }

  .ranking-card{
    flex:1;
    border-radius:12px;
    padding:14px;
    color:#fff;
    position:relative;
    overflow:hidden;
    min-height:86px;
    display:flex;
    flex-direction:column;
    justify-content:center;
  }
  /* gradient variants */
  .rank-antes{ background: linear-gradient(135deg,#50a8ff,#2b9ed8); box-shadow: 0 8px 30px rgba(43,158,216,0.26); }
  .rank-depois{ background: linear-gradient(135deg,#00b894,#01936b); box-shadow: 0 8px 30px rgba(1,147,107,0.26); }

  .rank-title{ font-weight:700; font-size:15px; opacity:0.95; margin-bottom:8px; }
  .rank-list{ font-size:15px; line-height:1.5; }
  .leader{
    display:inline-block;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(255,255,255,0.14);
    font-weight:700;
    margin-right:10px;
  }

  /* ===== Table modern ===== */
  .table-wrap{ overflow:auto; border-radius:12px; margin-top:12px; }
  table{
    width:100%;
    border-collapse:collapse;
    background:rgba(255,255,255,0.95);
    min-width:720px;
  }
  thead th{
    text-align:left;
    padding:12px;
    background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    border-bottom:2px solid rgba(14,74,110,0.06);
    color: #0d3b52;
    font-size:13px;
    position:sticky;
    top:0;
    z-index:2;
  }
  tbody td{
    padding:12px;
    border-bottom:1px solid rgba(14,74,110,0.04);
    font-size:14px;
    color: #0b3d51;
  }
  tbody tr:nth-child(odd){ background: linear-gradient(180deg, rgba(255,255,255,0.0), rgba(255,255,255,0.01)); }
  tbody tr:hover{ background: linear-gradient(90deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); }

  .muted{ color: rgba(11,36,64,0.5); font-size:13px; }
  .small{ font-size:13px; color: rgba(11,36,64,0.55) }

  /* highlight top1 */
  .top1 { box-shadow: 0 6px 18px rgba(0,0,0,0.12); transform: translateY(-4px); }

  @media(max-width:720px){
    .ranking-card{min-height:72px;padding:12px}
    thead th, tbody td{padding:10px;font-size:13px}
  }
</style>
</head>
<body>
<header><h1>Contagem de Motoristas</h1></header>

<main class="container">
  <div id="status" class="panel muted">Carregando dados da planilha...</div>

  <section class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <div class="small" style="font-weight:700;color:var(--muted)">Top 7 — Chegadas Cedo</div>
        <div class="muted">Aba: <strong>ANTES DO EXPEDIENTE</strong></div>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div id="cardAntes" class="ranking-card rank-antes">
        <div class="rank-title">Chegadas cedo — Top 7</div>
        <div id="rankListAntes" class="rank-list">Carregando...</div>
      </div>

      <div id="cardDepois" class="ranking-card rank-depois">
        <div class="rank-title">Saídas tarde — Top 7</div>
        <div id="rankListDepois" class="rank-list">Carregando...</div>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="section-head" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
      <div>
        <div class="section-title" style="margin:0 0 6px 0">Registros — Antes do expediente</div>
        <div class="muted">Exibindo registros mais recentes primeiro</div>
      </div>
    </div>

    <div class="table-wrap" style="margin-top:12px">
      <table id="tableAntes">
        <thead>
          <tr><th>Motorista</th><th>Data</th><th>Horário</th><th>Missão</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="panel">
    <div class="section-head" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
      <div>
        <div class="section-title" style="margin:0 0 6px 0">Registros — Depois do expediente</div>
        <div class="muted">Exibindo registros mais recentes primeiro</div>
      </div>
    </div>

    <div class="table-wrap" style="margin-top:12px">
      <table id="tableDepois">
        <thead>
          <tr><th>Motorista</th><th>Data</th><th>Horário</th><th>Missão</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<script>
/* =================== CONFIGURAÇÃO (já com seu ID e abas) =================== */
const SHEET_ID = "1eaFPPSEpMxsdUY9m3vT_fOhoYUKYBzATv55nRHQwyTY";
const ABA_ANTES = "ANTES DO EXPEDIENTE";
const ABA_DEPOIS = "DEPOIS DO EXPEDIENTE";
const BASE_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=`;

/* =================== PARSE UTILITÁRIOS =================== */

/* Interpreta strings vindo do Google GViz (Date(...) ou textos)
   Retorna objeto { date: Date|null, text: string } */
function parseGoogleCell(value){
  if (value === null || value === undefined) return {date:null, text:""};
  const s = String(value).trim();

  // Date(...) pattern
  const m = s.match(/^Date\(([-\d,\s]+)\)$/i);
  if (m){
    const parts = m[1].split(',').map(x=>parseInt(x.trim(),10));
    // Google uses Date(year,monthZeroBased,day, hour?, minute?, second?)
    if (parts.length >= 3){
      let [year, month, day, hour=0, minute=0, second=0] = parts;
      // If year < 1900 (e.g. 1899) Google used a time-only representation; treat as time
      if (year < 1900){
        // Use today's date combined with this time for ordering/display
        const now = new Date();
        const dt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, second);
        return {date:dt, text: ""};
      } else {
        const dt = new Date(year, month, day, hour, minute, second);
        return {date:dt, text: ""};
      }
    }
  }

  // Try ISO parse
  const iso = Date.parse(s);
  if (!isNaN(iso)){
    return {date:new Date(iso), text:""};
  }

  // Otherwise treat as text
  return {date:null, text:s};
}

function formatDate(d){
  if (!d) return "";
  return d.toLocaleDateString('pt-BR');
}
function formatTime(d){
  if (!d) return "";
  return d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
}

/* =================== FETCH SHEET =================== */
async function fetchSheet(aba){
  const url = BASE_URL + encodeURIComponent(aba);
  const res = await fetch(url, {cache:'no-store'});
  if (!res.ok) throw new Error(`Falha HTTP ${res.status}`);
  const txt = await res.text();

  // Trim wrapper: google returns something like "/*O_o*/\ngoogle.visualization.Query.setResponse({...});"
  const start = txt.indexOf('{');
  const end = txt.lastIndexOf('}');
  if (start === -1 || end === -1) throw new Error('Resposta inesperada do Google Sheets');
  const json = JSON.parse(txt.slice(start, end+1));
  const rows = (json.table && json.table.rows) ? json.table.rows : [];
  // convert each row to array of cell strings (prefer formatted string c.f when available)
  return rows.map(r => (r.c || []).map(c => {
    if (!c) return null;
    // prefer c.f when it exists and is string (more human readable), else c.v
    if (c.f && typeof c.f === 'string') return c.f;
    if (c.v !== undefined && c.v !== null) return String(c.v);
    return null;
  }));
}

/* =================== NORMALIZAÇÃO =================== */
/* Expect columns: motorista | data | horário | missão
   Only first 4 columns used; ignore extras. */
function normalize(rows){
  return rows.map(r => {
    const motoristaRaw = r[0] || "";
    const dataRaw = r[1] || "";
    const horaRaw = r[2] || "";
    const missaoRaw = r[3] || "";

    const motorista = String(motoristaRaw).trim();

    const parsedData = parseGoogleCell(dataRaw);
    const parsedHora = parseGoogleCell(horaRaw);

    // determine a dateObj for sorting
    let dateObj = null;
    if (parsedData.date && parsedHora.date){
      // combine date and time
      const d = parsedData.date, t = parsedHora.date;
      dateObj = new Date(d.getFullYear(), d.getMonth(), d.getDate(), t.getHours(), t.getMinutes(), t.getSeconds());
    } else if (parsedData.date && !parsedHora.date){
      dateObj = parsedData.date;
    } else if (!parsedData.date && parsedHora.date){
      // only time provided -> use today's date with that time
      const now = new Date();
      const t = parsedHora.date;
      dateObj = new Date(now.getFullYear(), now.getMonth(), now.getDate(), t.getHours(), t.getMinutes(), t.getSeconds());
    } else {
      // try parse both combined
      const combined = (String(dataRaw) + ' ' + String(horaRaw)).trim();
      const p = Date.parse(combined);
      if (!isNaN(p)) dateObj = new Date(p);
    }

    // display strings
    const displayDate = parsedData.date ? formatDate(parsedData.date) : (parsedData.text || String(dataRaw));
    const displayTime = parsedHora.date ? formatTime(parsedHora.date) : (parsedHora.text || String(horaRaw));

    const missao = String(missaoRaw || "");

    return { motorista, displayDate, displayTime, missao, dateObj };
  });
}

/* =================== ORDER & RENDER =================== */
function orderByDateDesc(items){
  // most recent first, nulls last
  return items.slice().sort((a,b)=>{
    if (!a.dateObj && !b.dateObj) return 0;
    if (!a.dateObj) return 1;
    if (!b.dateObj) return -1;
    return b.dateObj - a.dateObj;
  });
}

function renderTable(tableId, items){
  const tbody = document.querySelector(`#${tableId} tbody`);
  tbody.innerHTML = '';
  items.forEach(it => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(it.motorista)}</td>
      <td>${escapeHtml(it.displayDate)}</td>
      <td>${escapeHtml(it.displayTime)}</td>
      <td>${escapeHtml(it.missao)}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderRanking(containerId, items, highlightFirst=true){
  // count occurrences by motorista
  const counts = {};
  items.forEach(it => {
    const k = it.motorista || 'Sem nome';
    counts[k] = (counts[k] || 0) + 1;
  });
  const ranked = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,7);

  if (ranked.length === 0){
    document.getElementById(containerId).innerHTML = '<span class="muted">Sem registros</span>';
    return;
  }

  const frag = document.createDocumentFragment();
  ranked.forEach((entry, idx) => {
    const [name, qty] = entry;
    const div = document.createElement('div');
    if (idx === 0 && highlightFirst){
      div.className = 'top1';
      div.style.padding = '8px';
      div.style.borderRadius = '8px';
      div.style.background = 'rgba(255,255,255,0.06)';
      div.style.marginBottom = '8px';
    } else {
      div.style.marginBottom = '6px';
    }
    div.innerHTML = `<span style="font-weight:700">${idx+1}. ${escapeHtml(name)}</span> — <span style="opacity:0.95">${qty} registro(s)</span>`;
    frag.appendChild(div);
  });

  const container = document.getElementById(containerId);
  container.innerHTML = '';
  container.appendChild(frag);
}

/* =================== ESCAPE =================== */
function escapeHtml(s){
  if (s === null || s === undefined) return '';
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* =================== MAIN FLOW =================== */
async function loadAll(){
  try {
    document.getElementById('status').textContent = 'Carregando dados...';

    const [rowsAntes, rowsDepois] = await Promise.all([
      fetchSheet(ABA_ANTES),
      fetchSheet(ABA_DEPOIS)
    ]);

    // normalize and ignore empty rows
    const normAntes = normalize(rowsAntes).filter(r => r.motorista || r.displayDate || r.displayTime);
    const normDepois = normalize(rowsDepois).filter(r => r.motorista || r.displayDate || r.displayTime);

    const orderedAntes = orderByDateDesc(normAntes);
    const orderedDepois = orderByDateDesc(normDepois);

    // render tables (most recent first)
    renderTable('tableAntes', orderedAntes);
    renderTable('tableDepois', orderedDepois);

    // render rankings (use raw counts - here we count on normalized arrays)
    renderRanking('rankListAntes', normAntes);
    renderRanking('rankListDepois', normDepois);

    document.getElementById('status').textContent = 'Dados carregados com sucesso.';
  } catch (err) {
    console.error(err);
    document.getElementById('status').textContent = 'Erro ao carregar os dados: ' + (err.message || err);
  }
}

/* =================== START =================== */
loadAll();

/* =================== PWA: Manifest + Service Worker (dynamic single-file) =================== */
(function initPWA(){
  try{
    const manifest = {
      name: "Contagem de Motoristas",
      short_name: "Motoristas",
      start_url: ".",
      display: "standalone",
      background_color: "#e8f7ff",
      theme_color: "#1e90ff",
      icons:
